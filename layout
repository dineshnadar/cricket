function deepGroupFields(fields) {
  const grouped = { fieldsLeft: [], fieldsRight: [], fieldsFull: [] };
  let leftCount = 0, rightCount = 0;

  for (let i = 0; i < fields.length; i++) {
    const field = fields[i];
    
    // Assign seq if not present
    if (field.seq == null) field.seq = i;
    
    // Handle nested fields
    if (field.fields && field.fields.length > 0) {
      field.fieldType = 'nested';
      field.fields = deepGroupFields(field.fields);
    }

    // Determine side
    let side = field.side;
    if (!side || (side !== 'left' && side !== 'right' && side !== 'full')) {
      side = leftCount <= rightCount ? 'left' : 'right';
      side === 'left' ? leftCount++ : rightCount++;
    }
    
    // Add to appropriate array
    grouped[`fields${side.charAt(0).toUpperCase() + side.slice(1)}`].push(field);
  }

  // Sort each group
  for (const key in grouped) {
    grouped[key].sort((a, b) => (a.seq ?? 0) - (b.seq ?? 0));
    for (let i = 0; i < grouped[key].length; i++) {
      grouped[key][i].seq = i + 1;
    }
  }

  return grouped;
}

function optimizedGroupFieldsBySide(sections) {
  return sections.map(section => ({
    ...section,
    ...deepGroupFields(section.fields)
  }));
}

// Usage
const groupedSections = optimizedGroupFieldsBySide(originalSections);
console.log(JSON.stringify(groupedSections, null, 2));
