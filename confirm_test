// libs/shared/confirmation/src/lib/confirmation.service.spec.ts
import { TestBed } from '@angular/core/testing';
import { ConfirmationService } from './confirmation.service';
import { DomSanitizer, SecurityContext } from '@angular/platform-browser';

jest.mock('@angular/platform-browser');

describe('ConfirmationService', () => {
  let service: ConfirmationService;
  let sanitizer: jest.Mocked<DomSanitizer>;

  beforeEach(() => {
    TestBed.configureTestingModule({
      providers: [
        ConfirmationService,
        { provide: DomSanitizer, useValue: {
          sanitize: jest.fn().mockReturnValue('Sanitized Content')
        } }
      ]
    });
    
    service = TestBed.inject(ConfirmationService);
    sanitizer = TestBed.inject(DomSanitizer) as jest.Mocked<DomSanitizer>;
  });

  it('should be created', () => {
    expect(service).toBeTruthy();
  });

  it('should add a confirmation', () => {
    const id = service.confirm({
      id: 'test-id',
      header: 'Test Header',
      content: 'Test Content',
      accept: { action: jest.fn() }
    });

    expect(id).toBe('test-id');
    expect(service.activeConfirmations().length).toBe(1);
    expect(service.activeConfirmations()[0].header).toBe('Test Header');
    expect(service.activeConfirmations()[0].content).toBe('Sanitized Content');
  });

  it('should close a confirmation', () => {
    service.confirm({
      id: 'test-id',
      header: 'Test Header',
      content: 'Test Content',
      accept: { action: jest.fn() }
    });

    expect(service.activeConfirmations().length).toBe(1);

    service.close('test-id');

    expect(service.activeConfirmations().length).toBe(0);
  });

  it('should get confirmation by id', () => {
    service.confirm({
      id: 'test-id',
      header: 'Test Header',
      content: 'Test Content',
      accept: { action: jest.fn() }
    });

    const confirmation = service.getConfirmationById('test-id')();

    expect(confirmation).toBeTruthy();
    expect(confirmation?.header).toBe('Test Header');
  });

  it('should handle HTML content', () => {
    const htmlContent = '<p>Test <strong>HTML</strong></p>';
    sanitizer.sanitize.mockReturnValue(htmlContent);

    service.confirm({
      id: 'html-test',
      header: 'HTML Test',
      content: htmlContent,
      ok: { action: jest.fn() }
    });

    const confirmation = service.getConfirmationById('html-test')();

    expect(confirmation?.content).toBe(htmlContent);
    expect(sanitizer.sanitize).toHaveBeenCalledWith(SecurityContext.HTML, htmlContent);
  });
});

// libs/shared/confirmation/src/lib/confirmation-dialog/confirmation-dialog.component.spec.ts
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { ConfirmationDialogComponent } from './confirmation-dialog.component';
import { ConfirmationService } from '../confirmation.service';
import { By } from '@angular/platform-browser';
import { ChangeDetectionStrategy } from '@angular/core';

jest.mock('../confirmation.service');

describe('ConfirmationDialogComponent', () => {
  let component: ConfirmationDialogComponent;
  let fixture: ComponentFixture<ConfirmationDialogComponent>;
  let confirmationService: jest.Mocked<ConfirmationService>;

  beforeEach(async () => {
    await TestBed.configureTestingModule({
      imports: [ConfirmationDialogComponent],
      providers: [ConfirmationService]
    }).overrideComponent(ConfirmationDialogComponent, {
      set: { changeDetection: ChangeDetectionStrategy.Default }
    }).compileComponents();

    confirmationService = TestBed.inject(ConfirmationService) as jest.Mocked<ConfirmationService>;
  });

  beforeEach(() => {
    fixture = TestBed.createComponent(ConfirmationDialogComponent);
    component = fixture.componentInstance;
    component.id = 'test-id';
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should display confirmation content when available', () => {
    const mockConfirmation = {
      id: 'test-id',
      header: 'Test Header',
      content: 'Test Content',
      buttons: [{ label: 'OK', action: jest.fn() }]
    };

    confirmationService.getConfirmationById.mockReturnValue(() => mockConfirmation);

    fixture.detectChanges();

    const headerElement = fixture.debugElement.query(By.css('h2'));
    const contentElement = fixture.debugElement.query(By.css('.modal-content div'));
    const buttonElement = fixture.debugElement.query(By.css('button'));

    expect(headerElement.nativeElement.textContent).toBe('Test Header');
    expect(contentElement.nativeElement.innerHTML).toBe('Test Content');
    expect(buttonElement.nativeElement.textContent).toBe('OK');
  });

  it('should not display anything when no confirmation is available', () => {
    confirmationService.getConfirmationById.mockReturnValue(() => undefined);

    fixture.detectChanges();

    const modalElement = fixture.debugElement.query(By.css('.modal'));
    expect(modalElement).toBeNull();
  });

  it('should call action and close when button is clicked', () => {
    const mockAction = jest.fn();
    const mockConfirmation = {
      id: 'test-id',
      header: 'Test Header',
      content: 'Test Content',
      buttons: [{ label: 'OK', action: mockAction }]
    };

    confirmationService.getConfirmationById.mockReturnValue(() => mockConfirmation);

    fixture.detectChanges();

    const buttonElement = fixture.debugElement.query(By.css('button'));
    buttonElement.triggerEventHandler('click', null);

    expect(mockAction).toHaveBeenCalled();
    expect(confirmationService.close).toHaveBeenCalledWith('test-id');
  });
});

-------

export default {
  displayName: 'shared-confirmation',
  preset: '../../../jest.preset.js',
  setupFilesAfterEnv: ['<rootDir>/src/test-setup.ts'],
  globals: {},
  coverageDirectory: '../../../coverage/libs/shared/confirmation',
  transform: {
    '^.+\\.(ts|mjs|js|html)$': ['jest-preset-angular', {
      tsconfig: '<rootDir>/tsconfig.spec.json',
      stringifyContentPathRegex: '\\.(html|svg)$',
    }],
  },
  transformIgnorePatterns: ['node_modules/(?!.*\\.mjs$)'],
  snapshotSerializers: [
    'jest-preset-angular/build/serializers/no-ng-attributes',
    'jest-preset-angular/build/serializers/ng-snapshot',
    'jest-preset-angular/build/serializers/html-comment',
  ],
};
