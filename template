// src/app/components/personal-info/personal-info.component.ts
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { FormGroup, FormArray, FormControl, Validators } from '@angular/forms';
import { PersonalInfo } from '../../models/profile.model';

@Component({
  selector: 'app-personal-info',
  templateUrl: './personal-info.component.html'
})
export class PersonalInfoComponent {
  @Input() personalInfoForm: FormGroup;
  @Input() metadata: any;
  @Input() isEditMode = false;
  @Output() editModeChange = new EventEmitter<boolean>();

  get personalInfo(): PersonalInfo {
    return this.personalInfoForm.value;
  }

  toggleEditMode(): void {
    this.isEditMode = !this.isEditMode;
    this.editModeChange.emit(this.isEditMode);
  }

  addIdentification(): void {
    const identificationArray = this.personalInfoForm.get('identification') as FormArray;
    identificationArray.push(this.createIdentificationGroup());
  }

  removeIdentification(index: number): void {
    const identificationArray = this.personalInfoForm.get('identification') as FormArray;
    identificationArray.removeAt(index);
  }

  private createIdentificationGroup(): FormGroup {
    return new FormGroup({
      type: new FormControl('', Validators.required),
      number: new FormControl('', Validators.required)
    });
  }
}

// src/app/components/personal-info/personal-info.component.html
<ng-container *ngIf="!isEditMode">
  <ng-container *ngTemplateOutlet="readTemplate"></ng-container>
</ng-container>

<ng-container *ngIf="isEditMode">
  <ng-container *ngTemplateOutlet="editTemplate"></ng-container>
</ng-container>

<ng-template #readTemplate>
  <ng-container *ngTemplateOutlet="readPersonalInfoTemplate"></ng-container>
</ng-template>

<ng-template #editTemplate>
  <ng-container *ngTemplateOutlet="editPersonalInfoTemplate"></ng-container>
</ng-template>

// src/app/components/personal-info/personal-info-read.template.html
<ng-template #readPersonalInfoTemplate>
  <div class="personal-info-read">
    <h3>Personal Information</h3>
    <p><strong>Name:</strong> {{personalInfo.nameInfo.firstName}} {{personalInfo.nameInfo.lastName}}</p>
    <p><strong>SSN:</strong> {{personalInfo.ssn.type}} - {{personalInfo.ssn.number}}</p>
    <p><strong>Age:</strong> {{personalInfo.age}}</p>
    <p><strong>Date of Birth:</strong> {{personalInfo.dob | date}}</p>
    <p><strong>Marital Status:</strong> {{personalInfo.married ? 'Married' : 'Single'}}</p>
    <p><strong>USA Citizen:</strong> {{personalInfo.usa === 'Y' ? 'Yes' : 'No'}}</p>
    
    <h4>Identification Documents</h4>
    <ul>
      <li *ngFor="let id of personalInfo.identification">
        {{id.type}}: {{id.number}}
      </li>
    </ul>
    
    <button (click)="toggleEditMode()" [disabled]="!metadata?.editable">Edit</button>
  </div>
</ng-template>

// src/app/components/personal-info/personal-info-edit.template.html
<ng-template #editPersonalInfoTemplate>
  <form [formGroup]="personalInfoForm" class="personal-info-edit">
    <h3>Edit Personal Information</h3>
    
    <div formGroupName="nameInfo">
      <label>
        First Name:
        <input formControlName="firstName" [attr.disabled]="!metadata?.nameInfo?.firstName?.editable ? true : null">
      </label>
      <label>
        Last Name:
        <input formControlName="lastName" [attr.disabled]="!metadata?.nameInfo?.lastName?.editable ? true : null">
      </label>
    </div>
    
    <div formGroupName="ssn">
      <label>
        SSN Type:
        <input formControlName="type" [attr.disabled]="!metadata?.ssn?.type?.editable ? true : null">
      </label>
      <label>
        SSN Number:
        <input formControlName="number" [attr.disabled]="!metadata?.ssn?.number?.editable ? true : null">
      </label>
    </div>
    
    <label>
      Age:
      <input formControlName="age" type="number" [attr.disabled]="!metadata?.age?.editable ? true : null">
    </label>
    
    <label>
      Date of Birth:
      <input formControlName="dob" type="date" [attr.disabled]="!metadata?.dob?.editable ? true : null">
    </label>
    
    <label>
      Married:
      <input formControlName="married" type="checkbox" [attr.disabled]="!metadata?.married?.editable ? true : null">
    </label>
    
    <label>
      USA Citizen:
      <select formControlName="usa" [attr.disabled]="!metadata?.usa?.editable ? true : null">
        <option value="Y">Yes</option>
        <option value="N">No</option>
      </select>
    </label>
    
    <div formArrayName="identification">
      <h4>Identification Documents</h4>
      <div *ngFor="let id of personalInfoForm.get('identification')['controls']; let i = index" [formGroupName]="i">
        <label>
          ID Type:
          <input formControlName="type" [attr.disabled]="!metadata?.identification?.type?.editable ? true : null">
        </label>
        <label>
          ID Number:
          <input formControlName="number" [attr.disabled]="!metadata?.identification?.number?.editable ? true : null">
        </label>
        <button type="button" (click)="removeIdentification(i)" [disabled]="!metadata?.identification?.editable">Remove</button>
      </div>
      <button type="button" (click)="addIdentification()" [disabled]="!metadata?.identification?.editable">Add Identification</button>
    </div>
    
    <button type="button" (click)="toggleEditMode()">Cancel</button>
    <button type="submit" [disabled]="personalInfoForm.invalid">Save</button>
  </form>
</ng-template>
