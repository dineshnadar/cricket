import { Component, inject, effect, OnInit, computed, signal } from '@angular/core';
import { AsyncPipe } from '@angular/common';
import { ProfileBuilderService, ActiveWidget } from './profile-builder.service';
import { LeftMenuComponent } from './left-menu.component';

@Component({
  selector: 'app-party-builder',
  standalone: true,
  imports: [AsyncPipe, LeftMenuComponent],
  template: `
    <!-- ... other template parts ... -->
    @if (activeProfile()) {
      <div class="party-builder">
        <app-left-menu />
        <div #widgetContainer></div>
        <div class="widget-controls">
          <div class="acknowledgment">
            <label>
              <input type="checkbox" 
                     [checked]="isActiveWidgetAcknowledged()"
                     (change)="toggleActiveWidgetAcknowledgment()">
              Acknowledge this widget
            </label>
          </div>
          <div class="widget-navigation">
            <button (click)="loadPreviousWidget()" 
                    [disabled]="isNavigating() || isFirstWidget()">
              Previous
            </button>
            <button (click)="loadNextWidget()" 
                    [disabled]="isNavigating() || (isLastWidget() | async)">
              Next
            </button>
          </div>
          <div class="navigation-mode">
            <label>
              <input type="checkbox" [checked]="includeSubItems()" (change)="toggleNavigationMode()">
              Include sub-items in navigation
            </label>
          </div>
        </div>
      </div>
    }
    <!-- ... other template parts ... -->
  `,
  styles: [/* ... */]
})
export class PartyBuilderComponent implements OnInit {
  private profileBuilder = inject(ProfileBuilderService);

  isNavigating = signal(false);
  includeSubItems = signal(false);
  isActiveWidgetAcknowledged = signal(false);

  activeWidget = this.profileBuilder.getActiveWidget;
  visibleWidgets = this.profileBuilder.getVisibleWidgets;

  constructor() {
    effect(() => {
      // Update acknowledgment state when active widget changes
      const currentWidget = this.activeWidget();
      if (currentWidget) {
        this.isActiveWidgetAcknowledged.set(
          this.profileBuilder.isWidgetAcknowledged(currentWidget.widgetName)
        );
      } else {
        this.isActiveWidgetAcknowledged.set(false);
      }
    });
  }

  // ... existing properties and methods ...

  toggleActiveWidgetAcknowledgment() {
    const currentWidget = this.activeWidget();
    if (!currentWidget) return;

    const newAckState = !this.isActiveWidgetAcknowledged();
    this.profileBuilder.setWidgetAcknowledgment(currentWidget.widgetName, newAckState);
    this.isActiveWidgetAcknowledged.set(newAckState);
  }

  // ... other existing methods ...
}
