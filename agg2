function optimizedGroupFieldsThreeLevels(fields, level = 1) {
  const grouped = level !== 2 ? { fieldsLeft: [], fieldsRight: [], fieldsFull: [] } : [];
  let leftCount = 0, rightCount = 0;

  const fieldCount = fields.length;
  for (let i = 0; i < fieldCount; i++) {
    const field = fields[i];
    field.seq = field.seq ?? i;

    if (field.fields && field.fields.length) {
      field.fields = optimizedGroupFieldsThreeLevels(field.fields, level + 1);
    }

    if (level === 2) {
      grouped.push(field);
    } else {
      const side = field.side && ['left', 'right', 'full'].includes(field.side)
        ? field.side
        : (leftCount <= rightCount ? (leftCount++, 'left') : (rightCount++, 'right'));
      
      grouped[`fields${side.charAt(0).toUpperCase() + side.slice(1)}`].push(field);
    }
  }

  // Sort only once at the end
  if (level === 2) {
    grouped.sort((a, b) => a.seq - b.seq);
  } else {
    for (const key in grouped) {
      grouped[key].sort((a, b) => a.seq - b.seq);
    }
  }

  return grouped;
}

function optimizedGroupFieldsBySide(sections) {
  const sectionCount = sections.length;
  const result = new Array(sectionCount);
  for (let i = 0; i < sectionCount; i++) {
    const section = sections[i];
    const grouped = optimizedGroupFieldsThreeLevels(section.fields);
    delete section.fields;
    result[i] = { ...section, ...grouped };
  }
  return result;
}

// Performance testing function
function testPerformance(sections, iterations = 100) {
  const start = performance.now();
  for (let i = 0; i < iterations; i++) {
    optimizedGroupFieldsBySide(sections);
  }
  const end = performance.now();
  console.log(`Average time per iteration: ${(end - start) / iterations} ms`);
}

// Usage in Angular service
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root'
})
export class FieldGroupingService {
  groupFields(sections) {
    return optimizedGroupFieldsBySide(sections);
  }

  testPerformance(sections, iterations = 100) {
    testPerformance(sections, iterations);
  }
}
