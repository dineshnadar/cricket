import { Component, signal, computed } from '@angular/core';
import { CommonModule } from '@angular/common';
import { AccountService } from './account.service';

interface StructuredData {
  [label: string]: {
    [accountNumber: string]: string;
  };
}

@Component({
  selector: 'app-account-status',
  standalone: true,
  imports: [CommonModule],
  template: `
    <button (click)="loadAccountStatuses('sequential')">Load Sequential</button>
    <button (click)="loadAccountStatuses('debounced')">Load Debounced</button>
    <button (click)="loadFiveAccounts()">Load 5 Accounts</button>
    
    <div *ngIf="accountService.loading()">Loading...</div>
    <div *ngIf="accountService.error()" style="color: red;">{{ accountService.error() }}</div>
    
    <table *ngIf="tableData().labels.length" border="1">
      <thead>
        <tr>
          <th>Label</th>
          <th *ngFor="let account of tableData().accounts">{{ account }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let label of tableData().labels">
          <td>{{ label }}</td>
          <td *ngFor="let account of tableData().accounts">
            {{ tableData().data[label][account] || 'N/A' }}
          </td>
        </tr>
      </tbody>
    </table>
    
    <div *ngIf="!accountService.loading() && !tableData().labels.length">No results to display.</div>
  `
})
export class AccountStatusComponent {
  accountStatuses = signal<StructuredData[]>([]);
  private currentIndex = 0;

  tableData = computed(() => this.generateTableData(this.accountStatuses()));

  constructor(public accountService: AccountService) {}

  loadAccountStatuses(mode: 'sequential' | 'debounced') {
    const inputs = this.generateInputs(10); // Generate 10 sample inputs
    this.currentIndex = 0; // Reset index when loading all accounts

    this.accountService.getMultipleAccountStatuses(inputs, mode).subscribe({
      next: (statuses) => {
        this.accountStatuses.set(statuses);
      },
      error: (error) => {
        console.error('Error in component:', error);
        this.accountStatuses.set([]); // Clear previous results on error
      }
    });
  }

  loadFiveAccounts() {
    const allInputs = this.generateInputs(20); // Generate 20 sample inputs
    const fiveInputs = allInputs.slice(this.currentIndex, this.currentIndex + 5);
    this.currentIndex += 5;

    if (fiveInputs.length === 0) {
      console.log('No more accounts to load');
      return;
    }

    this.accountService.getMultipleAccountStatuses(fiveInputs, 'sequential').subscribe({
      next: (newStatuses) => {
        const currentStatuses = this.accountStatuses();
        this.accountStatuses.set([...currentStatuses, ...newStatuses]);
      },
      error: (error) => {
        console.error('Error loading 5 accounts:', error);
      }
    });
  }

  private generateInputs(count: number): any[] {
    return Array.from({ length: count }, (_, i) => ({
      bn: `101-${1000 + i}`,
      add: `${1000 + i} Sample St`
    }));
  }

  private generateTableData(statuses: StructuredData[]) {
    const data: StructuredData = {};
    const accountSet = new Set<string>();
    const labelSet = new Set<string>();

    statuses.forEach(status => {
      Object.entries(status).forEach(([label, accounts]) => {
        labelSet.add(label);
        if (!data[label]) data[label] = {};
        
        Object.entries(accounts).forEach(([account, value]) => {
          accountSet.add(account);
          data[label][account] = value;
        });
      });
    });

    return {
      data,
      labels: Array.from(labelSet),
      accounts: Array.from(accountSet).sort()
    };
  }
}
